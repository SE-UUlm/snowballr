name: Lint and Publish Wiki

on:
    push:
        branches:
            - main
    pull_request:
    workflow_dispatch:

jobs:
    linting:
        name: Linting Markdown
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - name: Install dependencies
              shell: bash
              run: npm install -g markdownlint-cli@0.45.0

            - name: Get branch name
              id: get_branch_name
              run: |
                  BRANCH_NAME=""
                  if [[ "${{ github.event_name }}" == "pull_request" ]]; then
                      BRANCH_NAME="${{ github.head_ref }}"
                  else
                      BRANCH_NAME="${{ github.ref_name }}"
                  fi
                  echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

            - name: Lint Markdown files
              run: npx markdownlint --config .github/markdownlint.json **/*.md

            # To verify whether the wiki links are up-to-date, we replace them with links to the current branch
            # In case, we change the path of a file we link to in the wiki, this would result in a broken link on this branch
            # If we wouldn't check this, the broken link would only be noticed on the develop branch
            - name: Replace GitHub URLs to develop with current branch
              run: node scripts/wiki-replace-github-urls.js ${{ steps.get_branch_name.outputs.branch_name }}

            - name: Check for Broken Links in README
              uses: becheran/mlc@v1.0.0
              with:
                  args: README.md

            - name: Check for Broken Links in Wiki
              uses: becheran/mlc@v1.0.0
              with:
                  args: wiki/

    publish-wiki:
        name: Publish Wiki
        if: github.ref_name == 'main' && github.ref_type == 'branch'
        runs-on: ubuntu-latest
        needs: linting
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Add auto-generated hint to wiki markdown files
              run: bash scripts/add_auto_gen_wiki_hint.sh

            - name: Publish the Wiki
              uses: Andrew-Chen-Wang/github-wiki-action@v5
              with:
                  path: "wiki/"
                  strategy: "init"
